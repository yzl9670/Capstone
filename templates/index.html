{% set is_admin = user.username == 'admin' %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LEED Rubrics Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-container {
            display: flex;
            flex: 1;
            height: 100%;
        }
        /*hide*/
        .left-menu {
            width: 0; 
            background-color: #4a76a8;
            color: #fff;
            padding: 0; 
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        .content {
            width: 70%; 
            padding: 20px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #e9ecef;
            padding: 20px;
            padding-bottom: 80px;
            border-radius: 10px;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
        }
        .chat-message.user {
            background-color: #d1e7dd;
            align-self: flex-end;
        }
        .chat-message.ai {
            background-color: #d0e2f2;
            align-self: flex-start;
            position: relative;
            display: flex;
            flex-direction: column;
            white-space: pre-wrap;
        }
        .input-container {
            position: static; 
            bottom: auto;
            left: auto;
            right: auto;
            background-color: #fff;
            padding: 10px 0;
            z-index: 2;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #ccc;
        }
        .input-container textarea {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
            min-height: 50px;
            max-height: 50%;
            overflow-y: auto;
        }
        .input-container button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .upload-button {
            position: relative;
            overflow: hidden;
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .upload-button input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .rubrics-container {
            width: 30%;
            padding: 20px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        .rubrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .rubrics-header h3 {
            margin: 0;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .rubrics-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            max-height: 80vh; 
        }
        .rubrics-list div {
            padding: 10px;
            background-color: #fafafa;
            border-radius: 5px;
            display: flex;
            align-items: flex-start;
            border: 1px solid #ddd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .rubrics-list textarea {
            flex-grow: 1;
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            resize: none;
            overflow-y: hidden;
            min-height: 50px;
            margin-right: 10px;
            background-color: transparent;
        }
        .rubrics-list textarea:focus {
            outline: none;
        }
        .rubric-button {
            padding: 5px 10px;
            font-size: 16px;
            border: none;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            cursor: pointer;
        }
        .rubric-button:hover {
            background-color: #c0392b;
        }
        
        #file-input {
            display: none;
        }
        
        .feedback-panel {
            position: absolute;
            bottom: 0;
            left: calc(100% + 10px);
            width: 175px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            z-index: 100;
        }
        .feedback-panel h4 {
            margin-top: 0;
        }
        .feedback-panel .close-button {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 18px;
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
        }
        .feedback-panel .stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .feedback-panel .stars span {
            font-size: 24px;
            cursor: pointer;
            color: #ccc;
        }
        .feedback-panel .stars span.selected {
            color: gold;
        }
        .feedback-panel textarea {
            width: 100%;
            resize: vertical;
            min-height: 50px;
            margin-top: 10px;
        }
        .feedback-panel button.submit-feedback {
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 14px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .feedback-button {
            margin-top: 10px;
            align-self: flex-end;
            font-size: 12px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        #leed-page {
            display: none;
            flex-direction: column;
            flex: 1;
        }
        #leed-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        #leed-table-container {
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        #leed-table {
            width: 100%;
            border-collapse: collapse;
        }
        #leed-table th, #leed-table td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: left;
        }
        #leed-table th {
            background-color: #e9ecef;
        }
        #leed-table .section-header {
            background-color: #d0e2f2;
            font-weight: bold;
        }
        #leed-table input[type="number"] {
            width: 80px;
        }
        
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .button-container .back-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Style for the submit button */
        .button-container #leed-submit-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        
        }
    
        .rubrics-list textarea[readonly] {
            background-color: transparent;
            cursor: default;
        }
        
        .chat-container.dragover {
            background-color: #c8e6c9;
        }
        /* Rubrics */
        .rubric-item {
            width: 95%;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: block;
        }
        .rubric-title {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            background-color: #f4f4f4;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            width: 90%;
            position: relative;
        }
        .rubric-title .title-text {
            flex-grow: 1;
        }
        .rubric-title .rubric-score {
            margin-left: 10px;
        }
        .rubric-content {
            display: none;
            flex-direction: column;
            padding: 0;
            background-color: #fff;
            border-top: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
        }
        .rubric-content.visible {
            display: block;
        }
        .message {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .message.red {
            color: red;
        }
        .message.green {
            color: green;
        }
        .rubric-criteria-item {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        .rubric-criteria-item div {
            margin-bottom: 5px;
        }
        .rubric-subcontent {
            padding: 10px 20px;
            margin: 0;
            background-color: #fff;
            border-left: 3px solid #ccc;
            display: none;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .rubric-subcontent.visible {
            display: flex;
        }
        .rubric-subtitle {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            margin: 0;
            background-color: #f9f9f9;
            position: relative;
        }
        .rubric-subtitle::after {
            content: '\25BA'; 
            position: absolute;
            right: 10px;
            transition: transform 0.3s;
        }
        .rubric-subtitle.expanded::after {
            transform: rotate(90deg); 
        }
        .rubric-score {
            font-weight: bold;
        }
        .rubrics-total-score {
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .leed-rubric-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            position: relative; 
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .resubmit-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px; 
            transition: all 0.3s ease; 
        }
        @media (max-width: 600px) {
            .resubmit-button {
                font-size: 12px;
                padding: 4px 8px;
                border-radius: 2px;
                position: static;
                margin-top: 10px;
            }
        }
        @media (max-width: 400px) {
            .resubmit-button {
                font-size: 10px;
                padding: 3px 6px;
            }
        }
        .resubmit-button:hover {
            background-color: #c0392b;
        }
        .rubric-criteria-item.highlight {
            background-color: #d0e2f2;
            border-left: 3px solid #4a76a8;
        }

        .logout-container {
            position: fixed;
            bottom: 20px; 
            right: 20px;  
            z-index: 1000; 
        }

        .logout-button {
            padding: 10px 20px;
            background-color: #e74c3c; 
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .logout-button:hover {
            background-color: #c0392b; 
        }
        .edit-button {
            margin-left: 10px;
            padding: 5px;
            font-size: 12px;
            cursor: pointer;
            background-color: #4CAF50; 
            color: white;
            border: none;
            border-radius: 3px;
        }
        /* Loading animation style */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #4a76a8;
            animation: spin 1s linear infinite;
            margin: 10px; 
        }
        .input-hint {
            font-size: 12px;
            color: #888;
            margin-left: 20px;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Hide individual rubric scores and total scores */
        .rubric-score,
        #rubrics-total-score {
            display: none;
        }
    </style>
    <script>
        var isAdmin = {{ is_admin | tojson }};
    </script>
</head>
<body>
    <div class="main-container" id="main-container">
        <!-- Left button section (hidden)） -->
        <div class="left-menu">
        </div>

        <div class="content">
            <div class="chat-container" id="chat-container">
                <div class="chat-message ai">Welcome to the AI feedback system! Feel free to drag and drop your assignment here!</div>
            </div>
            <div class="input-container">
                <label class="upload-button">
                    Upload
                    <input type="file" id="file-input" accept=".docx,.pdf" onchange="sendMessage()">
                </label>
                <textarea id="user-input" placeholder="Type your message here..." oninput="autoResizeTextarea(this)"></textarea>
                <button onclick="sendMessage()">Send</button>
            </div>
            <div class="input-hint">
                Press <b>Ctrl+Enter</b> to send message
            </div>
        </div>

        <!-- Rubrics section on the right -->
        <div class="rubrics-container" id="rubrics-container">
            <div class="leed-rubric-header" id="leed-rubric-header">
                Writing Rubric
            </div>
            <div class="rubrics-total-score" id="rubrics-total-score">
                Total Score: 0/15
            </div>
            <!-- LEED Rubrics List -->
            <div class="rubrics-list" id="leed-rubrics-list">
                <!-- LEED rubrics will be populated here -->
            </div>
        </div>
    </div>

    <script>
        let currentChatHistoryId = null;

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, window.innerHeight * 0.5) + 'px';
        }

        // Get the current Rubrics (in Writing mode only)
        function getCurrentRubrics() {
            const rubricsList = document.getElementById('writing-rubrics-list');
            const rubricTextareas = rubricsList.querySelectorAll('textarea');
            let rubrics = '';
            rubricTextareas.forEach(textarea => {
                rubrics += textarea.value + '\n\n';
            });
            return rubrics.trim();
        }

        function sendMessage() {
            // Get user input and file input 
            const input = document.getElementById('user-input');
            const fileInput = document.getElementById('file-input');
            const message = input.value;
            const file = fileInput.files[0];
        
            if (!message.trim() && !file) {
                alert("Please enter a message or upload a file.");
                return;
            }
        
            // Create a FormData object to send to the backend
            const formData = new FormData();
            formData.append('message', message);
        
            // If the user selects a file, add it to FormData
            if (file) {
                console.log('Selected file:', file);
                formData.append('file', file);
            } else {
                console.log('No file selected.');
            }
        
            // debug
            for (let pair of formData.entries()) {
                console.log(pair[0] + ', ' + pair[1]);
            }
        
            // Get the chat container 
            const chatContainer = document.getElementById('chat-container');
        
            // Display User Messages
            if (message.trim()) {
                const userMessageElem = document.createElement('div');
                userMessageElem.classList.add('chat-message', 'user');
                userMessageElem.textContent = message;
                chatContainer.appendChild(userMessageElem);
            } else if (file) {
                const userMessageElem = document.createElement('div');
                userMessageElem.classList.add('chat-message', 'user');
                userMessageElem.textContent = `Uploaded file: ${file.name}`;
                chatContainer.appendChild(userMessageElem);
            }
        
            // Add AI reply bubble, showing loading animation
            const aiMessageElem = document.createElement('div');
            aiMessageElem.classList.add('chat-message', 'ai');
        
            // Creating a loading animation element
            const loadingSpinner = document.createElement('div');
            loadingSpinner.classList.add('loading-spinner');
            aiMessageElem.appendChild(loadingSpinner);
        
            // Adding the AI ​​Message element to the chat container
            chatContainer.appendChild(aiMessageElem);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        
            // Clear the input box and file input
            input.value = '';
            input.style.height = '50px';
            fileInput.value = '';
        
            // Sending request to the backend
            fetch('/get_feedback', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success === false) {
                        alert(data.error);
                        // Remove loading animation
                        aiMessageElem.remove();
                        return;
                    }
        
                    console.log("Scores from backend (frontend):", data.scores);
                    // Updated AI reply bubble content, replacing loading animation with actual reply
                    aiMessageElem.innerHTML = ''; 
        
                    const aiContent = document.createElement('div');
                    aiContent.textContent = data.feedback; 
        
                    aiMessageElem.appendChild(aiContent);
        
                    // Feedback Button
                    const feedbackBtn = document.createElement('button');
                    feedbackBtn.classList.add('feedback-button');
                    feedbackBtn.textContent = 'Feedback';
                    feedbackBtn.onclick = function () {
                        toggleFeedbackPanel(aiMessageElem, data.chat_history_id, feedbackBtn);
                    };
                    aiMessageElem.appendChild(feedbackBtn);
        
                    chatContainer.scrollTop = chatContainer.scrollHeight;
        
                    updateRubricScores(data.scores, data?.rubric?.total_points);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing your request.');
        
                    // Remove loading animation
                    aiMessageElem.remove();
                });
        }
        
        // Update LEED Rubrics Ratings
        function updateRubricScores(items, rubricTotalPoints) {
            // items: [{ name, score, reasons }]
            const rubricsList = document.getElementById('leed-rubrics-list');
            const rubricItems = rubricsList.querySelectorAll('.rubric-item');

            const byName = new Map(items.map(i => [i.name, i]));
            let totalScore = 0;

            rubricItems.forEach(rubricElem => {
                const titleElem = rubricElem.querySelector('.rubric-title');
                const rubricName = titleElem.getAttribute('data-rubric-name');

                const item = byName.get(rubricName);
                if (!item) return;

                const scoreValue = Number(item.score) || 0;

                // Calculate the max points for this rubric from its criteria (fallback to 3 if missing)
                const criteriaItems = rubricElem.querySelectorAll('.rubric-criteria-item');
                const pointsList = Array.from(criteriaItems)
                    .map(ci => Number(ci.getAttribute('data-points')))
                    .filter(n => !Number.isNaN(n));
                const totalValue = pointsList.length ? Math.max(...pointsList) : 3;

                let scoreElem = titleElem.querySelector('.rubric-score');
                if (!scoreElem) {
                    scoreElem = document.createElement('span');
                    scoreElem.classList.add('rubric-score');
                    titleElem.appendChild(scoreElem);
                }
                scoreElem.textContent = `Score: ${scoreValue}/${totalValue}`;
                scoreElem.style.color = getScoreColor(scoreValue, totalValue);

                // Highlight: exact match first; otherwise closest lower/upper criteria
                criteriaItems.forEach(ci => ci.classList.remove('highlight'));
                let exact = false;
                criteriaItems.forEach(ci => {
                    const pts = Number(ci.getAttribute('data-points'));
                    if (pts === scoreValue) {
                        exact = true;
                        ci.classList.add('highlight');
                    }
                });
                if (!exact && criteriaItems.length) {
                    let lower = null, higher = null;
                    criteriaItems.forEach(ci => {
                        const pts = Number(ci.getAttribute('data-points'));
                        if (pts <= scoreValue) {
                            if (!lower || pts > Number(lower.getAttribute('data-points'))) lower = ci;
                        } else {
                            if (!higher || pts < Number(higher.getAttribute('data-points'))) higher = ci;
                        }
                    });
                    if (lower) lower.classList.add('highlight');
                    if (higher) higher.classList.add('highlight');
                }

                totalScore += scoreValue;
            });

            // Update total score (use backend rubric.total_points if available)
            const totalScoreElem = document.getElementById('rubrics-total-score');
            const denom = rubricTotalPoints || 15;
            totalScoreElem.textContent = `Total Score: ${totalScore}/${denom}`;
            totalScoreElem.style.color = getScoreColor(totalScore, denom);
        }

        function getScoreColor(score, maxScore) {
            const percentage = (score / maxScore) * 100;
            if (percentage < 50) {
                return '#FF0000';
            } else if (percentage >= 50 && percentage < 80) {
                return '#FFA500';
            } else {
                return '#008000';
            }
        }

        // Toggle display of the feedback panel
        function toggleFeedbackPanel(aiMessageElem, chatHistoryId, feedbackBtn) {
            let feedbackPanel = aiMessageElem.querySelector('.feedback-panel');
            if (feedbackPanel) {
                feedbackPanel.remove();
            } else {
                feedbackPanel = document.createElement('div');
                feedbackPanel.classList.add('feedback-panel');

                // Close button
                const closeButton = document.createElement('button');
                closeButton.classList.add('close-button');
                closeButton.innerHTML = '&times;';
                closeButton.onclick = function() {
                    feedbackPanel.remove();
                };
                feedbackPanel.appendChild(closeButton);

                const title = document.createElement('h4');
                title.textContent = 'How do you like this response?';
                feedbackPanel.appendChild(title);

                // Star Rating
                const starsDiv = document.createElement('div');
                starsDiv.classList.add('stars');
                for (let i = 1; i <= 5; i++) {
                    const starSpan = document.createElement('span');
                    starSpan.textContent = '★';
                    starSpan.dataset.value = i;
                    starSpan.onclick = function() {
                        selectStars(starsDiv, i);
                    };
                    starsDiv.appendChild(starSpan);
                }
                feedbackPanel.appendChild(starsDiv);

                // Feedback text box
                const feedbackTextarea = document.createElement('textarea');
                feedbackTextarea.placeholder = 'Enter your feedback...';
                feedbackPanel.appendChild(feedbackTextarea);

                // Submit Button
                const submitButton = document.createElement('button');
                submitButton.classList.add('submit-feedback');
                submitButton.textContent = 'Submit';
                submitButton.onclick = function() {
                    submitFeedback(chatHistoryId, getSelectedStars(starsDiv), feedbackTextarea.value);
                    feedbackPanel.remove();
                    feedbackBtn.style.display = 'none';
                };
                feedbackPanel.appendChild(submitButton);

                aiMessageElem.appendChild(feedbackPanel);

                // Check if the feedback panel exceeds the visible area and adjust its position
                const rect = feedbackPanel.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    feedbackPanel.style.left = 'auto';
                    feedbackPanel.style.right = 'calc(100% + 10px)';
                }
            }
        }

        // Select star rating
        function selectStars(starsDiv, rating) {
            const stars = starsDiv.querySelectorAll('span');
            stars.forEach(star => {
                if (parseInt(star.dataset.value) <= rating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }

        // Get the number of selected stars
        function getSelectedStars(starsDiv) {
            const selectedStars = starsDiv.querySelectorAll('span.selected');
            return selectedStars.length;
        }

        // Submit user feedback on AI responses
        function submitFeedback(chatHistoryId, rating, feedback) {
            fetch('/submit_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_history_id: chatHistoryId,
                    rating: rating,
                    feedback: feedback
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Thank you for your feedback!');
                } else {
                    alert('Failed to submit feedback: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting your feedback.');
            });
        }

        // Function to display LEED Rubrics (updated)
        function displayLeedRubrics(rubrics) {
            const rubricsList = document.getElementById('leed-rubrics-list');
            rubricsList.innerHTML = ''; 

            rubrics.forEach((rubricData, rubricIndex)=> {
                const rubricElem = document.createElement('div');
                rubricElem.classList.add('rubric-item');
                rubricElem.style.display = 'block';  // Ensure vertical alignment

                // Rubric Title 
                const titleElem = document.createElement('div');
                titleElem.classList.add('rubric-title');
                titleElem.setAttribute('data-rubric-name', rubricData.name);

                // Title Text
                const titleTextElem = document.createElement('span');
                titleTextElem.classList.add('title-text');
                titleTextElem.textContent = `${rubricData.name}`;

                // Score
                const scoreElem = document.createElement('span');
                scoreElem.classList.add('rubric-score');
                scoreElem.textContent = 'Score: 0/0'; 

                // Add title text and fraction to title element
                titleElem.appendChild(titleTextElem);
                titleElem.appendChild(scoreElem);

                // If admin, add `+/-` buttons
                // ADD EDIT BUTTON CODE HERE
                if (isAdmin && typeof WRITING_RUBRIC !== 'undefined') {
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('edit-button');
                    editButton.onclick = (event) => {
                        event.stopPropagation(); 
                        editRubric(rubricIndex);
                    };
                    titleElem.appendChild(editButton);
                }

                // Content container (used to store scoring criteria)
                const contentElem = document.createElement('div');
                contentElem.classList.add('rubric-content');
                contentElem.style.display = 'none'; 

                // Fill in the scoring criteria
                if (Array.isArray(rubricData.scoringCriteria) && rubricData.scoringCriteria.length > 0) {
                    rubricData.scoringCriteria.forEach((criteria, criteriaIndex) => {
                        const criteriaItemElem = document.createElement('div');
                        criteriaItemElem.classList.add('rubric-criteria-item');
                        criteriaItemElem.setAttribute('data-points', criteria.points);

                        // The title of the grading criteria (e.g. "2 Points")
                        const criteriaItemTitle = document.createElement('div');
                        criteriaItemTitle.textContent = `${criteria.points} Points`;
                        criteriaItemTitle.style.fontWeight = 'bold';

                        // Description of scoring criteria
                        const criteriaItemContent = document.createElement('div');
                        criteriaItemContent.classList.add('criteria-desc'); // mark the description node
                        criteriaItemContent.textContent = `${criteria.description}`;

                        // Add a title and description to a rubric item
                        criteriaItemElem.appendChild(criteriaItemTitle);
                        criteriaItemElem.appendChild(criteriaItemContent);

                        // If admin, add an edit button
                        if (isAdmin && typeof WRITING_RUBRIC !== 'undefined')  {
                            const editCriteriaButton = document.createElement('button');
                            editCriteriaButton.textContent = 'Edit';
                            editCriteriaButton.classList.add('edit-button');
                            editCriteriaButton.onclick = (event) => {
                                event.stopPropagation();
                                editScoringCriteria(rubricIndex, criteriaIndex);
                            };
                            criteriaItemElem.appendChild(editCriteriaButton);
                        }

                        // Add a rubric item to a content container
                        contentElem.appendChild(criteriaItemElem);
                    });
                } else {
                    contentElem.textContent = 'No scoring criteria available.';
                }

                // Toggle content display when clicking on title
                titleElem.addEventListener('click', function() {
                    if (contentElem.style.display === 'none') {
                        contentElem.style.display = 'block';
                        titleElem.classList.add('expanded');
                    } else {
                        contentElem.style.display = 'none';
                        titleElem.classList.remove('expanded');
                    }
                });

                // Adding a title and content to a Rubric element
                rubricElem.appendChild(titleElem);
                rubricElem.appendChild(contentElem);

                // Adding a Rubric Element to the Rubrics List
                rubricsList.appendChild(rubricElem);
            });
        }

        
        

        // When the page loads
        window.onload = function() {
            // 1. Get the last feedback and insert it after the welcome message
            fetch('/get_last_feedback', {
                method: 'GET',
                credentials: 'include' // Make sure to carry cookies to verify login status
            })
            .then(response => response.json())
            .then(data => {
                console.log("Last feedback data:", data);
                if (data.success && data.feedback) {
                    const chatContainer = document.getElementById('chat-container');
                    if (chatContainer) {
                        // Locate the default welcome message
                        const welcomeElem = chatContainer.querySelector('.chat-message.ai');
                        const feedbackElem = document.createElement('div');
                        feedbackElem.classList.add('chat-message', 'ai');
                        feedbackElem.textContent = data.feedback;
                        // If the welcome message is found, insert the feedback after it; otherwise insert it at the beginning
                        if (welcomeElem && welcomeElem.nextSibling) {
                            chatContainer.insertBefore(feedbackElem, welcomeElem.nextSibling);
                        } else if (welcomeElem) {
                            chatContainer.appendChild(feedbackElem);
                        } else {
                            chatContainer.insertBefore(feedbackElem, chatContainer.firstChild);
                        }
                    } else {
                        console.error("chat-container not found");
                    }
                } else {
                    console.log("No last feedback:", data.error);
                }
            })
            .catch(error => {
                console.error("Error fetching last feedback:", error);
            });
            
            // Load LEED data or Rubrics data based on user role
            // Load rubric definition from backend and render
            fetch('/api/rubric', { credentials: 'include' })
             .then(res => res.json())
             .then(apiRubric => {
                const displayRubric = buildDisplayRubricFromApi(apiRubric);
                displayLeedRubrics(displayRubric);
                // Reset total score display base
                const totalScoreElem = document.getElementById('rubrics-total-score');
                if (totalScoreElem && apiRubric?.total_points) {
                    totalScoreElem.textContent = `Total Score: 0/${apiRubric.total_points}`;
                }
            })
            .catch(err => console.error('Failed to load rubric from /api/rubric:', err));
            
            // Initialize the drag and drop upload function
            initDragAndDrop();
            
            // Bind Ctrl+Enter shortcut key to send message
            const userInput = document.getElementById('user-input');
            if (userInput) {
                userInput.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        };

        function initDragAndDrop() {

            const chatContainer = document.getElementById('chat-container');
            const inputContainer = document.querySelector('.input-container');
            const mainContainer = document.getElementById('main-container');

                //  Listen for drag events on the main container so dropping works anywhere
            [chatContainer, inputContainer, mainContainer].forEach(element => {
                element.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    chatContainer.classList.add('dragover');
                });

                element.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    chatContainer.classList.remove('dragover');
                });

                element.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    chatContainer.classList.remove('dragover');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = document.getElementById('file-input');
                        fileInput.files = files;
                        sendMessage();
                    }
                });
            });
            /* const chatContainer = document.getElementById('chat-container');
            const fileInput = document.getElementById('file-input');

            chatContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                chatContainer.classList.add('dragover');
            });

            chatContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                chatContainer.classList.remove('dragover');
            });

            chatContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                chatContainer.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    sendMessage();
                }
            });*/
        }

        function addRubric() {
            const rubricName = prompt('Enter new rubric name:');
            if (rubricName) {
                WRITING_RUBRIC.push({
                    name: rubricName,
                    scoringCriteria: []
                });
                displayLeedRubrics(WRITING_RUBRIC);
            }
        }
        
        function removeRubric(rubricIndex) {
            if (confirm('Are you sure you want to delete this rubric?')) {
                WRITING_RUBRIC.splice(rubricIndex, 1);
                displayLeedRubrics(WRITING_RUBRIC);
            }
        }
        
        function editRubric(rubricIndex) {
            const rubric = WRITING_RUBRIC[rubricIndex];
            const rubricElem = document.querySelectorAll('.rubric-item')[rubricIndex];
            const titleElem = rubricElem.querySelector('.rubric-title');
            const titleTextElem = titleElem.querySelector('.title-text');
        
            // Create an input box to replace the title text
            const input = document.createElement('input');
            input.type = 'text';
            input.value = rubric.name;
            input.style.width = '100%';
        
            // Replace title text with input box
            titleElem.replaceChild(input, titleTextElem);
        
            // Focus the input box and select text
            input.focus();
            input.select();
        
            // When the input box loses focus or the Enter key is pressed, the changes are saved
            input.onblur = function() {
                saveRubricName(rubricIndex, input.value);
            };
        
            input.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    input.blur();
                }
            };
        }
        
        function saveRubricName(rubricIndex, newName) {
            // Update Rubric Name
            WRITING_RUBRIC[rubricIndex].name = newName;
        
            // Re-display Rubrics
            displayLeedRubrics(WRITING_RUBRIC);
        
            // Automatically save changes
            saveLeedRubrics();
        }
        
        function addScoringCriteria(rubricIndex) {
            const points = prompt('Enter points for the scoring criteria:');
            const description = prompt('Enter description for the scoring criteria:');
            if (points && description) {
                WRITING_RUBRIC[rubricIndex].scoringCriteria.push({
                    points: parseFloat(points),
                    description: description
                });
                displayLeedRubrics(WRITING_RUBRIC);
            }
        }
        
        function removeScoringCriteria(rubricIndex, criteriaIndex) {
            if (confirm('Are you sure you want to delete this scoring criteria?')) {
                WRITING_RUBRIC[rubricIndex].scoringCriteria.splice(criteriaIndex, 1);
                displayLeedRubrics(WRITING_RUBRIC);
            }
        }
        
        function editScoringCriteria(rubricIndex, criteriaIndex) {
            const criteria = WRITING_RUBRIC[rubricIndex].scoringCriteria[criteriaIndex];
            const rubricElem = document.querySelectorAll('.rubric-item')[rubricIndex];
            const criteriaItemElem = rubricElem.querySelectorAll('.rubric-criteria-item')[criteriaIndex];
            const criteriaItemContent =
                criteriaItemElem.querySelector('.criteria-desc') ||
                criteriaItemElem.querySelector('div:nth-of-type(2)'); // The second child is the description element
        
            // Create a text area to replace the description text
            const textarea = document.createElement('textarea');
            textarea.value = criteria.description;
            textarea.style.width = '100%';
        
            // Replace description text with text area
            criteriaItemElem.replaceChild(textarea, criteriaItemContent);
        
            // Focus the text area and select the text
            textarea.focus();
            textarea.select();
        
            // Save changes when the text area loses focus or the Enter key is pressed
            textarea.onblur = function() {
                saveScoringCriteriaDescription(rubricIndex, criteriaIndex, textarea.value);
            };
        
            textarea.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    textarea.blur();
                }
            };
        }
        function saveScoringCriteriaDescription(rubricIndex, criteriaIndex, newDescription) {
            // Update Scoring Criteria description
            WRITING_RUBRIC[rubricIndex].scoringCriteria[criteriaIndex].description = newDescription;
        
            // Re-display Rubrics
            displayLeedRubrics(WRITING_RUBRIC);
        
            // Automatically save changes
            saveLeedRubrics();
        }
        
        function saveLeedRubrics() {
            fetch('/admin/save_leed_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ leed_data: WRITING_RUBRIC })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('LEED rubrics saved successfully.');
                } else {
                    alert('Failed to save LEED rubrics: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving LEED rubrics:', error);
            });
        }

        // Convert /api/rubric format to front-end display format
        function buildDisplayRubricFromApi(apiRubric) {
            // apiRubric.criteria = [{ name, desc, levels: { "3": "...", "2": "...", ... } }]
            return (apiRubric?.criteria || []).map(c => {
                const scoring = Object.entries(c.levels || {})
                    .map(([pts, desc]) => ({
                        points: Number(pts),
                        description: desc || ''
                    }))
                    // Sort by points descending (optional)
                    .sort((a, b) => b.points - a.points);
                return {
                    name: c.name,
                    scoringCriteria: scoring
                };
            });
        }
    </script>
    {% if user %}
        <div class="logout-container">
            <a href="{{ url_for('logout') }}" class="logout-button">Log Out</a>
        </div>
    {% endif %}
</body>
</html>
